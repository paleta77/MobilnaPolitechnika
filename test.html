<!DOCTYPE html>
<html>

<head>
	<title>CTI NAV</title>
</head>

<body>
	<object data="floor.svg" type="image/svg+xml" id="floor" xmlns="http://www.w3.org/2000/svg"
		xmlns:xlink="http://www.w3.org/1999/xlink"></object>
	<textarea id="edges" rows="30" cols="30"></textarea>
	<div id="buttons"></div>
	<button onclick="loadMesh()">Load</button>

	<script>
		var last = null;
		var mesh = { nodes: [], edges: [] }
		var a = document.getElementById("floor");
		var edges = document.getElementById("edges");
		var buttons = document.getElementById("buttons");
		var svgDoc;
		var layer3;

		var lineStyle = "stroke:#0000FF;stroke-width:0.6;stroke-linecap:square;stroke-linejoin:miter;stroke-miterlimit:4;";
		var pathStyle = "stroke:#00FF00;stroke-width:0.6;stroke-linecap:square;stroke-linejoin:miter;stroke-miterlimit:4;";

		a.addEventListener("load", function () {

			svgDoc = a.contentDocument;

			var delta = svgDoc.getElementsByTagName("circle");
			layer3 = svgDoc.getElementById("layer3");

			for (var i = 0; i < delta.length; i++) {
				delta[i].style.display = 'none';
				var title = delta[i].getElementsByTagName("title");
				var name = null;
				if (title.length > 0) {
					name = title[0].innerHTML;
				}

				var node = { element: delta[i], id: name, x: delta[i].cx.baseVal.value, y: delta[i].cy.baseVal.value, neighbors: [] };
				delta[i].myNode = node;
				mesh.nodes.push(node);

				if (name != null) {
					var btn = document.createElement("button");
					btn.innerHTML = name;
					btn.myNode = node;
					btn.onclick = function(e){dijkstra(mesh.nodes[11], e.target.myNode)};
					buttons.appendChild(btn); 
				}


				/*delta[i].addEventListener("mousedown", function (e) {
					if (last == null)
						last = e.target;
					else {
						console.log(last.id + " " + e.target.id);
						console.log(e.target);
						layer3.appendChild(getNode('line', { x1: last.cx.baseVal.value, y1: last.cy.baseVal.value, x2: e.target.cx.baseVal.value, y2: e.target.cy.baseVal.value, style: lineStyle }));
						var len = Math.sqrt(Math.pow(last.cx.baseVal.value - e.target.cx.baseVal.value, 2) + Math.pow(last.cy.baseVal.value - e.target.cy.baseVal.value, 2));
						edges.value += last.id + " " + e.target.id + " " + len + "\n";

						last = null;
					}
				}, false);*/
			}
		}, false);

		function getNode(n, v) {
			n = document.createElementNS("http://www.w3.org/2000/svg", n);
			for (var p in v)
				n.setAttributeNS(null, p, v[p]);
			return n
		}

		function loadMesh() {
			var lines = edges.value.split(/\n/);
			lines.forEach(function (el) {
				var parts = el.split(' ')
				if (parts.length >= 3) {
					var a = svgDoc.getElementById(parts[0]);
					var b = svgDoc.getElementById(parts[1]);
					var len = parseFloat(parts[2])
					layer3.appendChild(getNode('line', { x1: a.cx.baseVal.value, y1: a.cy.baseVal.value, x2: b.cx.baseVal.value, y2: b.cy.baseVal.value, style: lineStyle }));

					a.myNode.neighbors.push({ b: b.myNode, len: len });
					b.myNode.neighbors.push({ b: a.myNode, len: len });
					mesh.edges.push({ a: a.myNode, b: b.myNode, len: len });
				}
			});
		}

		function smallest(set) {
			var minimum = 0;

			for (var i = 1; i < set.length; i++) {
				if (set[i].dist < set[minimum].dist)
					minimum = i;
			}
			return minimum;
		}

		function dijkstra(start, end) {
			q = []

			for (var i = 0; i < mesh.nodes.length; i++) {
				var node = mesh.nodes[i];
				node.dist = Infinity;
				node.prev = null;
				q.push(node);
			}

			start.dist = 0;

			while (q.length > 0) {
				u_idx = smallest(q);
				u = q[u_idx];
				q.splice(u_idx, 1);

				for (var i = 0; i < u.neighbors.length; i++) {
					var v = u.neighbors[i];
					var alt = u.dist + v.len;
					if (alt < v.b.dist) {
						v.b.dist = alt;
						v.b.prev = u;
					}
				}
			}

			s = [];
			u = end;
			if (u.prev != null || u === start) {
				while (u != null) {
					s.unshift(u)
					u = u.prev
				}
			}

			while (layer3.firstChild) {
				layer3.firstChild.remove();
			}

			for (var i = 0; i < s.length - 1; i++) {
				var a = s[i];
				var b = s[i + 1];
				layer3.appendChild(getNode('line', { x1: a.x, y1: a.y, x2: b.x, y2: b.y, style: pathStyle }));
			}
		}


	</script>
</body>

</html>